class MCcontext{id;key;virtualCollection;constructor(t){let{id:e,key:n}=t;this.id=e,this.key=n??null,this.virtualCollection=new Set}render(){this.virtualCollection}createVirtual_FC(t,e){let n={Fn:t,parent_id:this.id,key:e};return this.virtualCollection.add(n),[{context:this.id,id_element:e},n]}createVirtual_Component(t,e,n){let l={component:t,parent_id:this.id,key:e,identifier:n};return this.virtualCollection.add(l),[{context:this.id,id_element:e},l]}}class MCState{id;value;key;virtualCollection;passport;constructor(t,e){e&&(this.local=e);let{value:n,key:l,id:r}=t;this.value=n,this.key=l,this.id=r,this.virtualCollection=new Set}getPassport(t){this.passport=t}set(t){this.passport&&(this.value=t,this.passport.value=this.value)}get(){return this.value}}class MCEngine{state;static active=!1;constructor(){}handlerRender(t,e,n){let l={};n||(n="obj");let r=new Proxy(t,{get:(r,o)=>"object"!=typeof t[o]?t[o]:(void 0===l[o]&&(l[o]=this.handlerRender(t[o],e,`${n}.${o}`)),Reflect.get(...arguments)),set:(n,l,r)=>(e(this.state),t[l])});return r}render(t){if(0===t.virtualCollection.length)return null;MCEngine.active=!0,t.virtualCollection.forEach(t=>{if(!t.context){MC.anonimCollection.forEach(e=>{if(e.key===t.id_element){let n;if(e.component){let l=[];e.controller.global.forEach(t=>{l.push(t.value)});let r=[];e.controller.local.forEach(t=>{r.push(t.value)}),n=e.component.render({global:l,local:r},e.props)[0]}else{let o=[];e.controller.forEach(t=>{o.push(t.value)}),n=e.Fn(o)[0]}e.HTMLElement.replaceWith(n),e.HTMLElement=n}}),MCEngine.active=!1;return}MC.mc_context_global.forEach(e=>{e.id===t.context&&e.virtualCollection.forEach(e=>{if(e.key===t.id_element){let n;if(e.component){let l=[];e.controller.global.forEach(t=>{l.push(t.value)});let r=[];e.controller.local.forEach(t=>{r.push(t.value)}),n=e.component.render({global:l,local:r},e.props)[0]}else{let o=[];e.controller.forEach(t=>{o.push(t.value)}),n=e.Fn(o)[0]}e.HTMLElement.replaceWith(n),e.HTMLElement=n}})})}),MCEngine.active=!1}static renderChilds_FC(t,e){let n=null,l=!1;return t?(t.virtualCollection.forEach(r=>{if(!r.component&&r.Fn.toString()===e.toString()){l=!0;let o=[];r.controller.forEach(t=>{o.push(t.value)});let a=r.Fn(o);a||((a=[])[0]=document.createElement("micro_component"),a[0].setAttribute("style","height: 0; width: 0; display: none;"),a[0].setAttribute("mc",t.id)),r.HTMLElement=a[0],n=r.HTMLElement}}),l)?n:"nt%Rnd#el":(MC.anonimCollection.forEach(t=>{if(!t.component&&t.Fn.toString()===e.toString()){l=!0;let r=[];t.controller.forEach(t=>{r.push(t.value)});let o=t.Fn(r);o||((o=[])[0]=document.createElement("micro_component"),o[0].setAttribute("style","height: 0; width: 0; display: none;"),o[0].setAttribute("mc","anon")),t.HTMLElement=o[0],n=t.HTMLElement}}),l)?n:"nt%Rnd#el"}static renderChilds_Component(t,e,n){if(!e)return console.error("[MC] Передайте при создании компонента его ключ! При отсутствии ключа, компонент может быть утерян!"),"nt%Rnd#el";"string"==typeof e&&(n=e);let[l,r]=e,o=null,a=!1;return r.context?(r.context.virtualCollection.forEach(t=>{if(!t.Fn&&t.identifier===n){a=!0;let e=[];t.controller.global.forEach(t=>{e.push(t.value)});let l=[];t.controller.local.forEach(t=>{l.push(t.value)});let i=t.component.render({global:e,local:l},r.props,t.props);i||((i=[])[0]=document.createElement("micro_component"),i[0].setAttribute("style","height: 0; width: 0; display: none;"),i[0].setAttribute("mc",context.id)),t.HTMLElement=i[0],o=t.HTMLElement}}),a)?o:"nt%Rnd#el":(MC.anonimCollection.forEach(t=>{if(!t.Fn&&t.identifier===n){a=!0;let e=[];t.controller.global.forEach(t=>{e.push(t.value)});let l=[];t.controller.local.forEach(t=>{l.push(t.value)});let i=t.component.render({global:e,local:l},r.props,t.props);i||((i=[])[0]=document.createElement("micro_component"),i[0].setAttribute("style","height: 0; width: 0; display: none;"),i[0].setAttribute("mc","anon")),t.HTMLElement=i[0],o=t.HTMLElement}}),a)?o:"nt%Rnd#el"}registrController(t){this.state=t;let e={value:t.id},n=this.handlerRender(e,this.render,"");t.getPassport(n)}}class MC_Component{constructor(t){return this.getComponent(t)}getComponent(t){return t}}class MC_Component_Registration{constructor(t){let[e,n,l]=t;"string"==typeof n&&(l=n,n=null);let r=n;return n||(r=[null,{context:null,props:null,states:null}]),MC.keys.push(l),this.register(e,r,l)}register(t,e,n){let[l,r]=e;if(r.context){let o=new t(r.props,r.context),a=[];MC.mc_state_global.forEach(t=>{t.local&&t.local===o&&a.push(t)});let i=MC.uuidv4(),[c,s]=r.context.createVirtual_Component(o,i,n),u=[];r.states&&r.states.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(c),u.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")});let p=[];a&&a.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(c),p.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")}),s.props=r.props;let C=o.render({global:u,local:p},r.props,r.props);if(!C){let m=document.createElement("micro_component");try{m.setAttribute("style","height: 0; width: 0; display: none;"),m.setAttribute("mc",r.context.id)}catch(d){console.error("[MC] Попытка формирования элемента закончилась неудачно, возможно пытаетесь отдать под контроль элемент, который уже чем-то контролируется.")}return s.controller={global:r.states,local:a},s.HTMLElement=m,m}let h=r.states?r.states:[];try{C[0].setAttribute("mc",r.context.id)}catch(M){console.error("[MC] Попытка формирования элемента закончилась неудачно, возможно пытаетесь отдать под контроль элемент, который уже чем-то контролируется.")}return s.controller={global:h,local:a||[]},s.HTMLElement=C[0],C[0]}{let $=new t(r.props,r.context),g=[];MC.mc_state_global.forEach(t=>{t.local&&t.local===$&&g.push(t)});let f=MC.uuidv4(),[v,E]=MC.createAnonimComponent($,f,n),y=[];r.states&&r.states.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(v),y.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")});let b=[];g&&g.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(v),b.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")}),E.props=r.props;let w=$.render({global:y,local:b},r.props,r.props);if(!w){let x=document.createElement("micro_component");try{x.setAttribute("style","height: 0; width: 0; display: none;"),x.setAttribute("mc","anon")}catch(A){console.error("[MC] Попытка формирования элемента закончилась неудачно, возможно пытаетесь отдать под контроль элемент, который уже чем-то контролируется.")}return E.controller={global:r.states,local:g},E.HTMLElement=x,x}let L=r.states?r.states:[];try{w[0].setAttribute("mc","anon")}catch(H){console.error("[MC] Попытка формирования элемента закончилась неудачно, возможно пытаетесь отдать под контроль элемент, который уже чем-то контролируется.")}return E.controller={global:L,local:g||[]},E.HTMLElement=w[0],w[0]}}}class MC{static keys=[];static mc_state_global=new Set;static mc_context_global=new Set;constructor(){if(MC._instance)return MC._instance}static init(){var t;t=window.$,console.log("window.$"),console.log(window.$),window.$=function(){if(arguments[0].prototype instanceof MC){if(MCEngine.active){let e=MCEngine.renderChilds_Component(...arguments);if("nt%Rnd#el"!==e)return e}return"string"==typeof arguments[1]?MC.keys.some(t=>t===arguments[1])&&console.error(`[MC] Обнаружено повторение ключа "${arguments[1]}" для компонента ${arguments[0].name}`):MC.keys.some(t=>t===arguments[2])&&console.error(`[MC] Обнаружено повторение ключа "${arguments[2]}" для компонента ${arguments[0].name}`),new MC_Component(new MC_Component_Registration(arguments))}let[n,l,r]=arguments;if("function"==typeof n){if(MCEngine.active){let o=MCEngine.renderChilds_FC(r,n);if("nt%Rnd#el"!==o)return o}if(r){let a=MC.uuidv4(),[i,c]=r.createVirtual_FC(n,a),s=[];l&&l.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(i),s.push(t.value)):console.warn("Не стейт")});let u=n(s);if(!u){let p=document.createElement("micro_component");try{p.setAttribute("style","height: 0; width: 0; display: none;"),p.setAttribute("mc",r.id)}catch(C){console.error("[MC] Попытка формирования элемента закончилась неудачно, возможно пытаетесь отдать под контроль элемент, который уже чем-то контролируется.")}return c.controller=l,c.HTMLElement=p,p}try{u[0].setAttribute("mc",r.id)}catch(m){console.error("[MC] Попытка формирования элемента закончилась неудачно, возможно пытаетесь отдать под контроль элемент, который уже чем-то контролируется.")}return c.controller=l,c.HTMLElement=u[0],u[0]}{let d=n,h=l,M=MC.uuidv4(),[$,g]=MC.createAnonim_FC(d,M),f=[];h&&h.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add($),f.push(t.value)):console.warn("Не стейт")});let v=d(f);if(!v){let E=document.createElement("micro_component");try{E.setAttribute("style","height: 0; width: 0; display: none;"),E.setAttribute("mc","anon")}catch(y){console.error("[MC] Попытка формирования элемента может закончится неудачей, возможно пытаетесь отдать под контроль элемент, который уже контролируется.")}return g.controller=h,g.HTMLElement=E,E}try{v[0].setAttribute("mc","anon")}catch(b){console.error("[MC] Попытка формирования элемента закончилась неудачно, возможно пытаетесь отдать под контроль элемент, который уже чем-то контролируется.")}return g.controller=h,g.HTMLElement=v[0],v[0]}}let w=t.apply(this,arguments);return w}}static anonimCollection=new Set;static createAnonim_FC(t,e){let n={Fn:t,parent_id:null,key:e};return MC.anonimCollection.add(n),[{context:null,id_element:e},n]}static createAnonimComponent(t,e,n){let l={component:t,parent_id:null,key:e,identifier:n};return MC.anonimCollection.add(l),[{context:null,id_element:e},l]}state(t,e){return MC.createLocallyState(t,e,this)}static Props(t){let e=[],n={props:null,context:null,states:[]};for(let l in t){if(!Array.isArray(t[l])&&t[l]instanceof MCcontext){e[2]={context:t[l]},n.context=t[l];continue}if(Array.isArray(t[l])&&t[l].every(t=>t instanceof MCState)){e[1]={states:t[l]},n.states=t[l];continue}e[0]={props:t[l]},n.props=t[l]}return[e,n]}static uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16))}static createState(t,e){let n={value:t,key:e,id:MC.uuidv4()},l=new MCState(n);return new MCEngine().registrController(l),MC.mc_state_global.add(l),l}static createLocallyState(t,e,n){let l={value:t,id:MC.uuidv4(),key:e},r=new MCState(l,n);return new MCEngine().registrController(r),MC.mc_state_global.add(r),r}static createContext(t){let e={id:MC.uuidv4(),key:t},n=new MCcontext(e);return MC.mc_context_global.add(n),n}newKey(t){if(!t)return MC.uuidv4();{let e=[];for(let n=0;n<t;n++)e.push(MC.uuidv4());return e}}static getState(t){let e=[];return MC.mc_state_global.forEach(n=>{n.key===t&&e.push(n)}),e}static getContext(){let t;return MC.mc_context_global.forEach(e=>{e.id===id&&(t=e)}),t}}