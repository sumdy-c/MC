// v6.4
class MCcontext{id;key;virtualCollection;constructor(t){let{id:e,key:n}=t;this.id=e,this.key=n??null,this.virtualCollection=new Set}render(){this.virtualCollection}createVirtual_FC(t,e){let n={Fn:t,parent_id:this.id,key:e};return this.virtualCollection.add(n),[{context:this.id,id_element:e},n]}createVirtual_Component(t,e,n){let l={component:t,parent_id:this.id,key:e,identifier:n};return this.virtualCollection.add(l),[{context:this.id,id_element:e},l]}}class MCState{id;value;key;virtualCollection;passport;constructor(t,e){e&&(this.local=e);let{value:n,key:l,id:o}=t;this.value=n,this.key=l,this.id=o,this.virtualCollection=new Set}getPassport(t){this.passport=t}set(t){(!MC.MC_setting.controlled||JSON.stringify(t)!==JSON.stringify(this.value))&&this.passport&&(this.value=t,this.passport.value=this.value)}get(){return JSON.parse(JSON.stringify(this.value))}}class MCEngine{state;static active=!1;handlerRender(t,e,n){let l={};n||(n="obj");let o=new Proxy(t,{get:(o,r)=>"object"!=typeof t[r]?t[r]:(void 0===l[r]&&(l[r]=this.handlerRender(t[r],e,`${n}.${r}`)),Reflect.get(...arguments)),set:(n,l,o)=>(e(this.state),t[l])});return o}render(t){if(0===t.virtualCollection.length)return null;t.virtualCollection.forEach(t=>{if(MCEngine.active=!0,!t.context){MC.anonimCollection.forEach(e=>{if(e.component&&e.key===t.id_element){let n,l=[];e.controller.global.forEach(t=>{l.push(t.value)});let o=[];e.controller.local.forEach(t=>{o.push(t.value)});let r={onDemand:!1},a=function(t){t(r)};if(n=e.component.render({global:l,local:o},e.props,a),!r.onDemand)n=n?n[0]:MC_Component.createEmptyElement(),e.HTMLElement.replaceWith(n),e.HTMLElement=n}}),MC.functionCollecton.forEach(e=>{if(e.Fn&&e.key===t.id_element){let n,l=[];e.controller.forEach(t=>{l.push(t.value)});let o={onDemand:!1},r=function(t){t(o)};n=e.Fn(l,r),o.onDemand&&MC.mc_solo_render_global.add(e.Fn.toString()),n?n.length&&(n=n[0]):n=MC_Component.createEmptyElement(),e.HTMLElement.replaceWith(n),e.HTMLElement=n}}),MCEngine.active=!1;return}MC.mc_context_global.forEach(e=>{e.id===t.context&&e.virtualCollection.forEach(e=>{if(e.key===t.id_element){let n;if(e.component){let l=[];e.controller.global.forEach(t=>{l.push(t.value)});let o=[];e.controller.local.forEach(t=>{o.push(t.value)});let r={onDemand:!1},a=function(t){t(r)};if(n=e.component.render({global:l,local:o},e.props,a),r.onDemand)return;n=n?n[0]:MC_Component.createEmptyElement()}else{let i=[];e.controller.forEach(t=>{i.push(t.value)}),n=(n=e.Fn(i))?n[0]:MC_Component.createEmptyElement()}e.HTMLElement.replaceWith(n),e.HTMLElement=n}})})}),MCEngine.active=!1}static renderChilds_FC(t,e){let n=null,l=!1;return t?(t.virtualCollection.forEach(t=>{if(!t.component&&t.Fn.toString()===e.toString()){l=!0;let o=[];t.controller.forEach(t=>{o.push(t.value)});let r=t.Fn(o);r=r?r[0]:MC_Component.createEmptyElement(),t.HTMLElement=r,n=t.HTMLElement}}),l)?n:"nt%Rnd#el":(MC.functionCollecton.forEach(t=>{if(!t.component&&t.Fn.toString()===e.toString()){l=!0;let o=[];t.controller&&0!==t.controller.length?t.controller.forEach(t=>{o.push(t.value)}):MC.mc_solo_render_global.add(t.Fn.toString());let r={onDemand:!1},a=function(t){t(r)},i=t.Fn(o,a);r.onDemand&&MC.mc_solo_render_global.add(t.Fn.toString()),i=i?i[0]:MC_Component.createEmptyElement(),t.HTMLElement=i,n=t.HTMLElement}}),l)?n:"nt%Rnd#el"}static renderChilds_Component(t,e,n){if(!e)return console.error("[MC] Передайте при создании компонента его ключ! При отсутствии ключа, компонент может быть утерян!"),"nt%Rnd#el";"string"==typeof e&&(n=e);let[l,o]=e,r=null,a=!1;return o.context?(o.context.virtualCollection.forEach(t=>{if(!t.Fn&&t.identifier===n){a=!0;let[l,i]=e;if(i.controlled){r=t.HTMLElement;return}let c=[];t.controller.global.forEach(t=>{c.push(t.value)});let s=[];t.controller.local.forEach(t=>{s.push(t.value)});let u={onDemand:!1},C=function(t){t(u)},m=t.component.render({global:c,local:s},o.props,C);!u.onDemand&&(t.props=o.props,m?m.length&&(m=m[0]):m=MC_Component.createEmptyElement(),t.HTMLElement=m,r=t.HTMLElement)}}),a)?r:"nt%Rnd#el":(MC.anonimCollection.forEach(t=>{if(!t.Fn&&t.identifier===n){a=!0;let[l,i]=e;if(i.controlled){r=t.HTMLElement;return}let c=[];t.controller.global.forEach(t=>{c.push(t.value)});let s=[];t.controller.local.forEach(t=>{s.push(t.value)});let u={onDemand:!1},C=function(t){t(u)},m=t.component.render({global:c,local:s},o.props,C);!u.onDemand&&(t.props=o.props,m=m?m[0]:MC_Component.createEmptyElement(),t.HTMLElement=m,r=t.HTMLElement)}}),a)?r:"nt%Rnd#el"}registrController(t){this.state=t;let e={value:t.id},n=this.handlerRender(e,this.render,"");t.getPassport(n)}}class MC_Component{constructor(t){return this.getComponent(t)}static createEmptyElement(){let t=document.createElement("micro_component");return t.setAttribute("style","height: 0; width: 0; display: none;"),t.setAttribute("mc",!0),t}getComponent(t){return t}}class MC_Component_Registration{constructor(t){let[e,n,l]=t;"string"==typeof n&&(l=n,n=null);let o=n;return n||(o=[null,{context:null,props:null,states:null},]),MC.keys.push(l),this.register(e,o,l)}register(t,e,n){let[l,o]=e;if(o.context){let r=new t(o.props,o.context,n),a=[];MC.mc_state_global.forEach(t=>{t.local&&t.local===r&&a.push(t)});let i=MC.uuidv4(),[c,s]=o.context.createVirtual_Component(r,i,n),u=[];o.states&&o.states.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(c),u.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")});let C=[];a&&a.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(c),C.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")}),s.props=o.props;let m={onDemand:!1},d=function(t){t(m)},p=r.render({global:u,local:C},o.props,d);if(!p){let M=MC_Component.createEmptyElement();return s.controller={global:o.states,local:a},s.HTMLElement=M,M}let h=o.states?o.states:[],f=a||[];return p.length?(p[0].setAttribute("mc",!0),s.controller={global:h,local:f},s.HTMLElement=p[0],p[0]):(p.setAttribute("mc",!0),s.controller={global:h,local:f},s.HTMLElement=p,p)}{let g=new t(o.props,o.context,n),E=[];MC.mc_state_global.forEach(t=>{t.local&&t.local===g&&E.push(t)});let $=MC.uuidv4(),[v,y]=MC.createAnonimComponent(g,$,n),b=[];o.states&&o.states.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(v),b.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")});let x=[];E&&E.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(v),x.push(t.value)):console.error("[MC] Ошибка обработки объекта контролёра.")}),y.props=o.props;let L={onDemand:!1},S=function(t){t(L)},H=g.render({global:b,local:x},o.props,S);if(!H){let T=MC_Component.createEmptyElement();return y.controller={global:o.states,local:E},y.HTMLElement=T,T}let _=o.states?o.states:[],w=E||[];return H.length?(H[0].setAttribute("mc",!0),y.controller={global:_,local:w},y.HTMLElement=H[0],H[0]):(H.setAttribute("mc",!0),y.controller={global:_,local:w},y.HTMLElement=H,H)}}}class MC{static keys=[];static anonimCollection=new Set;static functionCollecton=new Set;static mc_state_global=new Set;static mc_context_global=new Set;static mc_solo_render_global=new Set;static mc_demand_render_global=new Set;static MC_setting={controlled:!1};constructor(){if(MC._instance)return MC._instance}static init(t){var e=window.$;return MC.MC_setting.controlled=!t||t.controlled,window.$.MC=function(){if(arguments[0].prototype instanceof MC){if(MCEngine.active){let t=MCEngine.renderChilds_Component(...arguments);if("nt%Rnd#el"!==t)return t}let n=t=>"string"==typeof t[2]?t[2]:"string"==typeof t[1]?t[1]:void 0;if(n(arguments)&&MC.keys.includes(n(arguments))){let l,[o,r]=arguments[1];return r.context?r.context.virtualCollection.forEach(t=>{if(t.identifier===arguments[2]){let e=MCEngine.renderChilds_Component(...arguments);"nt%Rnd#el"!==e&&(l=e)}}):MC.anonimCollection.forEach(t=>{if(t.identifier===arguments[2]){let e=MCEngine.renderChilds_Component(...arguments);"nt%Rnd#el"!==e&&(l=e)}}),l}return new MC_Component(new MC_Component_Registration(arguments))}let[a,i,c]=arguments;if("function"==typeof a){let s=!1;if(MC.mc_solo_render_global.forEach(t=>{t===a.toString()&&(s=!0)}),s)return;if(MCEngine.active){let u=MCEngine.renderChilds_FC(c,a);if("nt%Rnd#el"!==u)return u}if(c){console.error("MC | ОБРАТИТЕ ВНИМАНИЕ!"),console.warn("MC | Использование контекста в функциональных контейнерах - устарело! Все функциональные контейнеры перенесены в отдельную область видимости. Удалите контекст и получите доступ с помощью: MC.functionCollecton");let C=MC.uuidv4(),[m,d]=c.createVirtual_FC(a,C),p=[];i&&i.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(m),p.push(t.value)):console.warn("Не стейт")});let M=a(p);if(!M){let h=MC_Component.createEmptyElement();return d.controller=i,d.HTMLElement=h,h}return M.length?(M[0].setAttribute("mc",!0),d.controller=i,d.HTMLElement=M[0],M[0]):(M.setAttribute("mc",!0),d.controller={global:global_st,local:local_st},d.HTMLElement=M,M)}{let f;if(MC.functionCollecton.forEach(t=>{if(t.Fn&&t.Fn.toString()===a.toString()){let e=MCEngine.renderChilds_FC(c,a);"nt%Rnd#el"!==e&&(f=e)}}),f)return f;let g=a,E=i,$=MC.uuidv4(),[v,y]=MC.createAnonim_FC(g,$),b=[];E&&E.map(t=>{"MCState"===t.__proto__.constructor.name?(t.virtualCollection.add(v),b.push(t.value)):console.warn("Не стейт")}),E&&E.length||MC.mc_solo_render_global.add(g.toString());let x={onDemand:!1},L=function(t){t(x)},S=g(b,L);if(x.onDemand&&MC.mc_solo_render_global.add(g.toString()),!S){let H=MC_Component.createEmptyElement();return y.controller=E,y.HTMLElement=H,H}return S.length?(S[0].setAttribute("mc",!0),y.controller=E,y.HTMLElement=S[0],S[0]):(S.setAttribute("mc",!0),y.controller=E,y.HTMLElement=S,S)}}let T=e.apply(this,arguments);return T},"Добро пожаловать в MC.js!"}static createAnonim_FC(t,e){let n={Fn:t,parent_id:null,key:e};return MC.functionCollecton.add(n),[{context:null,id_element:e},n]}static createAnonimComponent(t,e,n){let l={component:t,parent_id:null,key:e,identifier:n};return MC.anonimCollection.add(l),[{context:null,id_element:e},l]}state(t,e){return MC.createLocallyState(t,e,this)}static Props(t){let e=[],n={props:null,controlled:!1,context:null,states:[]};for(let l in t){if(!Array.isArray(t[l])&&t[l]instanceof MCcontext){e[2]={context:t[l]},n.context=t[l];continue}if(Array.isArray(t[l])&&t[l].every(t=>t instanceof MCState)){e[1]={states:t[l]},n.states=t[l];continue}"controlled"===l&&(n.controlled=t[l]),e[0]={props:t[l]},n.props=t[l]}return[e,n]}static uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16))}static createState(t,e){let n={value:t,key:e,id:MC.uuidv4()},l=new MCState(n);return new MCEngine().registrController(l),MC.mc_state_global.add(l),l}static uState(t,e,n){e||console.error("[MC] При создании уникального состояния необходимо указывать ключ!");let[l]=MC.getState(e);return l?(n||l.set(t),l):MC.createState(t,e)}static uContext(t){t||console.error("[MC] При создании уникального контекста необходимо указывать ключ!");let e=MC.getContext(t);return e||MC.createContext(t)}static createLocallyState(t,e,n){let l={value:t,id:MC.uuidv4(),key:e},o=new MCState(l,n);return new MCEngine().registrController(o),MC.mc_state_global.add(o),o}static createContext(t){let e={id:MC.uuidv4(),key:t},n=new MCcontext(e);return MC.mc_context_global.add(n),n}newKey(t){if(!t)return MC.uuidv4();{let e=[];for(let n=0;n<t;n++)e.push(MC.uuidv4());return e}}static getState(t){let e=[];return MC.mc_state_global.forEach(n=>{n.key===t&&e.push(n)}),e}static getContext(t){let e;return MC.mc_context_global.forEach(n=>{n.key===t&&(e=n)}),e}}